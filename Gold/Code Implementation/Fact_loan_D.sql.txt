CREATE OR REPLACE TABLE IBRD_PROJECT.IBRD_GOLD.FACT_LOAN_DEDUPED AS
WITH t AS (
    SELECT *
    FROM IBRD_PROJECT.IBRD_GOLD.FACT_LOAN
),

-- CLEAN DATE FUNCTION
cleaned AS (
    SELECT
        t.*,

        /* SAFE DATE CLEANING (empty → NULL, invalid → NULL) */
        NULLIF(TRIM(END_OF_PERIOD), '') AS END_OF_PERIOD_STR,
        NULLIF(TRIM(AGREEMENT_SIGNING_DATE), '') AS AGREEMENT_SIGNING_DATE_STR,
        NULLIF(TRIM(FIRST_REPAYMENT_DATE), '') AS FIRST_REPAYMENT_DATE_STR,
        NULLIF(TRIM(LAST_REPAYMENT_DATE), '') AS LAST_REPAYMENT_DATE_STR,
        NULLIF(TRIM(BOARD_APPROVAL_DATE), '') AS BOARD_APPROVAL_DATE_STR,
        NULLIF(TRIM(EFFECTIVE_DATE), '') AS EFFECTIVE_DATE_STR,
        NULLIF(TRIM(CLOSED_DATE), '') AS CLOSED_DATE_STR,
        NULLIF(TRIM(LAST_DISBURSEMENT_DATE), '') AS LAST_DISBURSEMENT_DATE_STR,

        /* SAFE NUMERIC CLEANING USING REGEXP + TO_NUMBER (NO TYPE ERRORS EVER) */
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.ORIGINAL_PRINCIPAL_AMOUNT_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_ORIGINAL,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.CANCELLED_AMOUNT_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_CANCELLED,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.UNDISBURSED_AMOUNT_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_UNDISBURSED,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.DISBURSED_AMOUNT_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_DISBURSED,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.REPAID_TO_IBRD_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_REPAID_IBRD,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.DUE_TO_IBRD_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_DUE_IBRD,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.EXCHANGE_ADJUSTMENT_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_EXCHANGE_ADJ,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.BORROWERS_OBLIGATION_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_OBLIGATION,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.SOLD_3RD_PARTY_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_SOLD_3RD,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.REPAID_3RD_PARTY_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_REPAID_3RD,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.DUE_3RD_PARTY_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_DUE_3RD,
        COALESCE(TO_NUMBER(REGEXP_REPLACE(t.LOANS_HELD_USD, '[^0-9.-]', ''), 38, 10), 0) AS NUM_HELD

    FROM t
),

-- FINAL DEDUPING STEP
dedup AS (
    SELECT
        *,
        ROW_NUMBER() OVER (
            PARTITION BY LOAN_NUMBER, END_OF_PERIOD_STR
            ORDER BY LOAN_NUMBER
        ) AS rn
    FROM cleaned
)

SELECT
    LOAN_NUMBER,
    PROJECT_ID,
    PROJECT_NAME,
    COUNTRY_ECONOMY_CODE,
    COUNTRY_ECONOMY,
    REGION,
    GUARANTOR_COUNTRY_ECONOMY_CODE,
    GUARANTOR,
    BORROWER,
    LOAN_TYPE,
    LOAN_STATUS,
    CURRENCY_OF_COMMITMENT,
    INTEREST_RATE,

    /* CLEANED DATES (final cast) */
    TRY_TO_DATE(END_OF_PERIOD_STR, 'YYYY-MM-DD') AS END_OF_PERIOD,
    TRY_TO_DATE(AGREEMENT_SIGNING_DATE_STR, 'YYYY-MM-DD') AS AGREEMENT_SIGNING_DATE,
    TRY_TO_DATE(FIRST_REPAYMENT_DATE_STR, 'YYYY-MM-DD') AS FIRST_REPAYMENT_DATE,
    TRY_TO_DATE(LAST_REPAYMENT_DATE_STR, 'YYYY-MM-DD') AS LAST_REPAYMENT_DATE,
    TRY_TO_DATE(BOARD_APPROVAL_DATE_STR, 'YYYY-MM-DD') AS BOARD_APPROVAL_DATE,
    TRY_TO_DATE(EFFECTIVE_DATE_STR, 'YYYY-MM-DD') AS EFFECTIVE_DATE,
    TRY_TO_DATE(CLOSED_DATE_STR, 'YYYY-MM-DD') AS CLOSED_DATE,
    TRY_TO_DATE(LAST_DISBURSEMENT_DATE_STR, 'YYYY-MM-DD') AS LAST_DISBURSEMENT_DATE,

    /* CLEANED NUMERICS */
    NUM_ORIGINAL AS ORIGINAL_PRINCIPAL_AMOUNT_USD,
    NUM_CANCELLED AS CANCELLED_AMOUNT_USD,
    NUM_UNDISBURSED AS UNDISBURSED_AMOUNT_USD,
    NUM_DISBURSED AS DISBURSED_AMOUNT_USD,
    NUM_REPAID_IBRD AS REPAID_TO_IBRD_USD,
    NUM_DUE_IBRD AS DUE_TO_IBRD_USD,
    NUM_EXCHANGE_ADJ AS EXCHANGE_ADJUSTMENT_USD,
    NUM_OBLIGATION AS BORROWERS_OBLIGATION_USD,
    NUM_SOLD_3RD AS SOLD_3RD_PARTY_USD,
    NUM_REPAID_3RD AS REPAID_3RD_PARTY_USD,
    NUM_DUE_3RD AS DUE_3RD_PARTY_USD,
    NUM_HELD AS LOANS_HELD_USD

FROM dedup
WHERE rn = 1;
