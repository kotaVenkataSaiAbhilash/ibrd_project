USE DATABASE IBRD_PROJECT;
USE SCHEMA IBRD_GOLD;

CREATE OR REPLACE STREAM SILVER_MASTER_STREAM
ON TABLE SILVER_MASTER
APPEND_ONLY = TRUE;

USE DATABASE IBRD_PROJECT;
USE SCHEMA IBRD_GOLD;

-- Create/replace the task (runs every 1 minute or change schedule as required)
CREATE OR REPLACE TASK IBRD_PROJECT.IBRD_GOLD.TASK_PROCESS_SILVER_TO_GOLD
WAREHOUSE = IBRD
SCHEDULE = 'USING CRON * * * * * UTC'  -- every minute; change as needed
WHEN SYSTEM$STREAM_HAS_DATA('IBRD_PROJECT.IBRD_SILVER.SILVER_MASTER_STREAM')
AS
CALL IBRD_PROJECT.IBRD_GOLD.PROC_PROCESS_SILVER_TO_GOLD();

ALTER TASK IBRD_PROJECT.IBRD_GOLD.TASK_PROCESS_SILVER_TO_GOLD RESUME;