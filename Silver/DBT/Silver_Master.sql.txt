
{{ config(
    materialized='incremental',
    unique_key='LOAN_NUMBER',     
    schema='SILVER',
    database='IBRD_PROJECT',
    incremental_strategy='append'
) }}

WITH src AS (
    SELECT *
    FROM {{ ref('stage_snowpark_loans') }}
),

final AS (
    SELECT
        END_OF_PERIOD,
        LOAN_NUMBER,
        REGION,
        COUNTRY_ECONOMY_CODE,
        COUNTRY_ECONOMY,
        BORROWER,
        GUARANTOR_COUNTRY_ECONOMY_CODE,
        GUARANTOR,
        LOAN_TYPE,
        LOAN_STATUS,
        CAST(INTEREST_RATE AS FLOAT) AS INTEREST_RATE,

        -- Currency fix
        CASE 
            WHEN CURRENCY_OF_COMMITMENT IS NULL OR TRIM(CURRENCY_OF_COMMITMENT) = '' 
                THEN 'US Dollars'
            ELSE CURRENCY_OF_COMMITMENT
        END AS CURRENCY_OF_COMMITMENT,

        PROJECT_ID,
        PROJECT_NAME,

        -- Date parsing
        COALESCE(
            TRY_TO_DATE(FIRST_REPAYMENT_DATE, 'DD-MM-YYYY'),
            TRY_TO_DATE(FIRST_REPAYMENT_DATE, 'MM/DD/YYYY'),
            TRY_TO_DATE(FIRST_REPAYMENT_DATE)
        ) AS FIRST_REPAYMENT_DATE,

        COALESCE(
            TRY_TO_DATE(LAST_REPAYMENT_DATE, 'DD-MM-YYYY'),
            TRY_TO_DATE(LAST_REPAYMENT_DATE, 'MM/DD/YYYY'),
            TRY_TO_DATE(LAST_REPAYMENT_DATE)
        ) AS LAST_REPAYMENT_DATE,

        COALESCE(
            TRY_TO_DATE(AGREEMENT_SIGNING_DATE, 'DD-MM-YYYY'),
            TRY_TO_DATE(AGREEMENT_SIGNING_DATE, 'MM/DD/YYYY'),
            TRY_TO_DATE(AGREEMENT_SIGNING_DATE)
        ) AS AGREEMENT_SIGNING_DATE,

        COALESCE(
            TRY_TO_DATE(BOARD_APPROVAL_DATE, 'DD-MM-YYYY'),
            TRY_TO_DATE(BOARD_APPROVAL_DATE, 'MM/DD/YYYY'),
            TRY_TO_DATE(BOARD_APPROVAL_DATE)
        ) AS BOARD_APPROVAL_DATE,

        COALESCE(
            TRY_TO_DATE(EFFECTIVE_DATE, 'DD-MM-YYYY'),
            TRY_TO_DATE(EFFECTIVE_DATE, 'MM/DD/YYYY'),
            TRY_TO_DATE(EFFECTIVE_DATE)
        ) AS EFFECTIVE_DATE,

        COALESCE(
            TRY_TO_DATE(CLOSED_DATE, 'DD-MM-YYYY'),
            TRY_TO_DATE(CLOSED_DATE, 'MM/DD/YYYY'),
            TRY_TO_DATE(CLOSED_DATE)
        ) AS CLOSED_DATE,

        COALESCE(
            TRY_TO_DATE(LAST_DISBURSEMENT_DATE, 'DD-MM-YYYY'),
            TRY_TO_DATE(LAST_DISBURSEMENT_DATE, 'MM/DD/YYYY'),
            TRY_TO_DATE(LAST_DISBURSEMENT_DATE)
        ) AS LAST_DISBURSEMENT_DATE,

        CAST(ORIGINAL_PRINCIPAL_AMOUNT_USD AS FLOAT) AS ORIGINAL_PRINCIPAL_AMOUNT_USD,
        CAST(CANCELLED_AMOUNT_USD AS FLOAT) AS CANCELLED_AMOUNT_USD,
        CAST(UNDISBURSED_AMOUNT_USD AS FLOAT) AS UNDISBURSED_AMOUNT_USD,
        CAST(DISBURSED_AMOUNT_USD AS FLOAT) AS DISBURSED_AMOUNT_USD,
        CAST(REPAID_TO_IBRD_USD AS FLOAT) AS REPAID_TO_IBRD_USD,
        CAST(DUE_TO_IBRD_USD AS FLOAT) AS DUE_TO_IBRD_USD,
        CAST(EXCHANGE_ADJUSTMENT_USD AS FLOAT) AS EXCHANGE_ADJUSTMENT_USD,
        CAST(BORROWERS_OBLIGATION_USD AS FLOAT) AS BORROWERS_OBLIGATION_USD,
        CAST(SOLD_3RD_PARTY_USD AS FLOAT) AS SOLD_3RD_PARTY_USD,
        CAST(REPAID_3RD_PARTY_USD AS FLOAT) AS REPAID_3RD_PARTY_USD,
        CAST(DUE_3RD_PARTY_USD AS FLOAT) AS DUE_3RD_PARTY_USD,
        CAST(LOANS_HELD_USD AS FLOAT) AS LOANS_HELD_USD
    FROM src
)

SELECT * FROM final
