CREATE OR REPLACE STREAM IBRD_LOANS_LANDING_STREAM
ON TABLE IBRD_LOANS_LANDING
APPEND_ONLY = TRUE;

--CREATE OR REPLACE TABLE IBRD_LOANS_RAW LIKE IBRD_LOANS_LANDING;

CREATE OR REPLACE TASK refresh_raw_ibrd_task
    WAREHOUSE = COMPUTE_WH               -- your warehouse
    SCHEDULE = 'USING CRON * * * * * UTC' -- runs every minute
    WHEN SYSTEM$STREAM_HAS_DATA('IBRD_LOANS_LANDING_STREAM')
AS
BEGIN
    -- 1. TRUNCATE the final RAW table
    TRUNCATE TABLE IBRD_LOANS_RAW;

    -- 2. Insert ONLY the new data captured by STREAM
    INSERT INTO IBRD_LOANS_RAW (
  END_OF_PERIOD,
  LOAN_NUMBER,
  REGION,
  COUNTRY_ECONOMY_CODE,
  COUNTRY_ECONOMY,
  BORROWER,
  GUARANTOR_COUNTRY_ECONOMY_CODE,
  GUARANTOR,
  LOAN_TYPE,
  LOAN_STATUS,
  INTEREST_RATE,
  CURRENCY_OF_COMMITMENT,
  PROJECT_ID,
  PROJECT_NAME,
  ORIGINAL_PRINCIPAL_AMOUNT_USD,
  CANCELLED_AMOUNT_USD,
  UNDISBURSED_AMOUNT_USD,
  DISBURSED_AMOUNT_USD,
  REPAID_TO_IBRD_USD,
  DUE_TO_IBRD_USD,
  EXCHANGE_ADJUSTMENT_USD,
  BORROWERS_OBLIGATION_USD,
  SOLD_3RD_PARTY_USD,
  REPAID_3RD_PARTY_USD,
  DUE_3RD_PARTY_USD,
  LOANS_HELD_USD,
  FIRST_REPAYMENT_DATE,
  LAST_REPAYMENT_DATE,
  AGREEMENT_SIGNING_DATE,
  BOARD_APPROVAL_DATE,
  EFFECTIVE_DATE,
  CLOSED_DATE,
  LAST_DISBURSEMENT_DATE
)
SELECT
  END_OF_PERIOD,
  LOAN_NUMBER,
  REGION,
  COUNTRY_ECONOMY_CODE,
  COUNTRY_ECONOMY,
  BORROWER,
  GUARANTOR_COUNTRY_ECONOMY_CODE,
  GUARANTOR,
  LOAN_TYPE,
  LOAN_STATUS,
  INTEREST_RATE,
  CURRENCY_OF_COMMITMENT,
  PROJECT_ID,
  PROJECT_NAME,
  ORIGINAL_PRINCIPAL_AMOUNT_USD,
  CANCELLED_AMOUNT_USD,
  UNDISBURSED_AMOUNT_USD,
  DISBURSED_AMOUNT_USD,
  REPAID_TO_IBRD_USD,
  DUE_TO_IBRD_USD,
  EXCHANGE_ADJUSTMENT_USD,
  BORROWERS_OBLIGATION_USD,
  SOLD_3RD_PARTY_USD,
  REPAID_3RD_PARTY_USD,
  DUE_3RD_PARTY_USD,
  LOANS_HELD_USD,
  FIRST_REPAYMENT_DATE,
  LAST_REPAYMENT_DATE,
  AGREEMENT_SIGNING_DATE,
  BOARD_APPROVAL_DATE,
  EFFECTIVE_DATE,
  CLOSED_DATE,
  LAST_DISBURSEMENT_DATE
FROM IBRD_LOANS_LANDING_STREAM;

END;

ALTER TASK refresh_raw_ibrd_task RESUME;

EXECUTE TASK TEST_IBRD.TEST_IBRD_SCH.REFRESH_RAW_IBRD_TASK;